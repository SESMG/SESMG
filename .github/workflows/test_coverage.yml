name: Test coverage

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11"]

    steps:
    - uses: actions/checkout@v1

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install system dependencies
      run: sudo apt-get update && sudo apt-get install -y libboost-all-dev build-essential cmake

    - name: Prepare CoolProp data
      run: |
        mkdir -p ~/.CoolProp
        wget -O ~/.CoolProp/all_fluids.json.z https://raw.githubusercontent.com/CoolProp/CoolProp/master/all_fluids.json.z || echo "File not found. Skipping download."

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install coverage
        pip install pytest
        pip install -r requirements.txt
        pip install scrutinizer-ocular

    - name: Clone CoolProp with submodules
      run: git clone --recurse-submodules https://github.com/CoolProp/CoolProp.git

    - name: Copy all_fluids.json.z to CoolProp/dev if it exists
      run: |
        mkdir -p CoolProp/dev
        if [ -f ~/.CoolProp/all_fluids.json.z ]; then
          cp ~/.CoolProp/all_fluids.json.z CoolProp/dev/
        else
          echo "Warning: all_fluids.json.z not found. Proceeding without it."
        fi

    - name: Build and install CoolProp from source
      run: |
        cd CoolProp
        pip install .

    - name: Test with coverage
      run: coverage run -m pytest tests

    - name: Codecov
      uses: codecov/codecov-action@v3.1.0
      with:
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Code Climate Coverage Action
      uses: paambaati/codeclimate-action@v3.0.0
      env:
        CC_TEST_REPORTER_ID: c38d5cc724ab734c45fc13b40613d17b2bbaab370d2dfd9e1ef4696b14ca6362